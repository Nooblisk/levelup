<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="css/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #ffffff;
            background-size: cover;
        }


    </style>
</head>
<body>
<h1></h1>

<div class="ui container">

    <!--Верхний ряд с картой пользователя и кнопками создания фичи, логина, логаута-->
    <div class="ui four column grid">
        <div class="row">
            <div class="left floated three wide column">
                <div id="" class="ui card">
                    <div class="content">
                        <div id="userUsername" class="header"></div>
                        <div id="userLevel" class="meta"></div>
                        <div id="userEmail" class="description">

                        </div>
                    </div>
                </div>
            </div>
            <div class="left floated three wide column">
                <button id="buttonCreateFeature" class="ui button" type="submit">Create new feature</button>
            </div>
            <div class="right floated two wide column">
                <button class="ui button signIn" type="submit" style="display: none">Sign In</button>
            </div>
            <div class="right floated two wide column">
                <button class="ui button signOut" type="submit" style="display: none">Sign Out</button>
            </div>

        </div>
    </div>

    <!--Окно ввода логина и пароля-->
    <div id="modalLogin" class="ui small modal">
        <div class="content">
            <form class="ui form">
                <div class="required field">
                    <label>Login</label>
                    <input id="loginInput" type="text" name="first-name" placeholder="test" maxlength="50">
                </div>
                <div class="required field">
                    <label>Password</label>
                    <input id="passwordInput" type="text" name="last-name" placeholder="test" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div id="buttonLogin" class="ui bottom attached positive button">
                Login
            </div>
        </div>
    </div>

    <!--Окно создания новой фичи-->
    <div id="modalCreateFeature" class="ui small modal">
        <div class="header">
            Create feature
        </div>
        <div class="content">
            <form class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInput" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInput" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Image</label>
                    <input type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Create
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <!--Окно добавления нового квеста-->
    <div id="modalCreateQuest" class="ui small modal">
        <div class="header">
            Create quest
        </div>
        <div class="content">
            <form class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleQuestInput" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionQuestInput" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>maxLevel</label>
                    <input id="maxLevelQuestInput" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Id</label>
                    <input id="idInputQuestUpdate" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Create
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <!--Окно обновления фичи-->
    <div id="modalUpdateFeature" class="ui small modal">
        <div class="header">
            Update feature
        </div>
        <div class="content">
            <form class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInputUpdate" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInputUpdate" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Image</label>
                    <input type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Update
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <!--Окно обновления фичи-->
    <div id="modalUpdateQuest" class="ui small modal">
        <div class="header">
            Update quest
        </div>
        <div class="content">
            <form class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInputUpdateQuest" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInputUpdateQuest" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Max level</label>
                    <input id="maxLevelInputUpdateQuest" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Update
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <!--Контейнер содержащий список фич и их отображение + квесты-->
    <div class="ui two column grid container">
        <div class="left floated four wide column">
            <div id="templateList" class="ui massive list"
                 style="overflow-y:auto;white-space:nowrap;width:auto;height:390px;padding:5px;border:solid 1px white;"></div>
        </div>
        <div class="right floated twelve wide column">
            <div id="templateColumn" class="ui raised very padded container" style="display: none">

            </div>
            <!--<div id="templateListQuests" class="ui list"-->
                 <!--style="overflow-y:auto;white-space:nowrap;width:auto;height:250px;padding:5px;border:solid 1px white;">-->

            <!--</div>-->

        </div>
    </div>


    <h4 id="headerText" class="ui header"></h4>
    <h4 id="headerText2" class="ui header"></h4>
    <h4 id="headerText3" class="ui header"></h4>
    <h4 id="headerText4" class="ui header"></h4>
</div>

<!--Шаблон контейнера с информацией о фиче и кнопками-->
<script id="templateContainerUpSegment" type="text/x-handlebars-template">
    <div id="containerFeature{{id}}" class="containerFeature" style="display:none" data-id="{{id}}">
        <div class="ui container">
            <div class="ui tiny image">
                <img src={{image_url}}>
            </div>
            <div class="content">
                <a class="header">{{title}}</a>

                <div class="description">
                    <p>{{description}}</p>
                </div>
                <div class="extra">
                    уровень {{level}}
                </div>
            </div>
            <button class="ui feature delete compact negative icon button" data-id="{{id}}">
                <i class="trash outline icon"></i>
            </button>
            <button class="ui feature update compact button" data-id="{{id}}">
                Изменить
            </button>
            <button class="ui quest post compact button" data-id="{{id}}">
                Добавить квест
            </button>
            <div id="templateListQuests{{id}}" class="ui list quests" data-id="{{id}}"
                 style="overflow-y:auto;white-space:nowrap;width:auto;height:250px;padding:5px;border:solid 1px white;"></div>
        </div>
    </div>
</script>

<!--Шаблон списка квестов по данной фиче-->
<script id="templateContainerDownSegment" type="text/x-handlebars-template">
    <div class="item quest" data-id="{{id}}">
        <div class="content">
            <div class="header">{{title}}</div>
            <div class="meta">
                <span>уровень {{level}} из {{max_level}}</span>
            </div>
            <div class="description">
                <p>{{description}}</p>
                <div id="stepStarRating{{id}}" class="ui star rating" data-rating="4" data-id="{{id}}">
                </div>
            </div>
            <div class="extra">
                <div class="ui left floated quest delete button" data-id="{{id}}">
                    Удалить квест
                </div>
                <div class="ui left floated quest update button" data-id="{{id}}">
                    Изменить квест
                </div>
            </div>

        </div>
    </div>
</script>

<!--Шаблон фичи в списке-->
<script id="templateFeature" type="text/x-handlebars-template">
    <div class="item feature" data-id="{{id}}">
        <img class="ui avatar image" src={{image_url}}>

        <div class="content">
            <div class="header">{{title}}</div>
            уровень {{level}}
        </div>
    </div>
</script>

<!--Шаблон шага в квесте-->
<script id="templateStep" type="text/x-handlebars-template">
    <i id="step{{id}}" class="icon active step" data-id="{{id}}"></i>
</script>

<script id="templateStepNotActive" type="text/x-handlebars-template">
    <i class="icon step"></i>
</script>


<script src="js/jquery-2.2.1.min.js"></script>
<script src="js/semantic.min.js"></script>
<script src="js/handlebars-v4.0.5.js"></script>


<script>

    var templateList = $("#templateList");
    var templateColumn = $("#templateColumn");
   // var templateListQuests = $('#templateListQuests');


    var template = Handlebars.compile($('#templateFeature').html());
    var template2 = Handlebars.compile($('#templateContainerUpSegment').html());
    var template3 = Handlebars.compile($('#templateContainerDownSegment').html());
    var template4 = Handlebars.compile($('#templateStep').html());
    var template5 = Handlebars.compile($('#templateStepNotActive').html());


    //конструктор апи клиента, содержит все необходимые методы для работы с апи сервера(ещё не все)
    function ApiClient() {
        var baseUrl = "/app_dev.php/api";
        var clientId = "1_web";
        var clientSecret = "web";
        var AuthInfo;
        this.setAuthInfo = function (AuthInfoObject) {
            AuthInfo = AuthInfoObject;
        };
        this.AuthInfo = function () {
            return AuthInfo;
        };
        this.getAuthorizationHeaders = function () {
            return {Authorization: 'Bearer ' + this.AuthInfo().access_token};
        };
        this.postAuthorization = function (username, password) {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/oauth/v2/token",
                data: {
                    grant_type: "password",
                    client_id: clientId,
                    client_secret: clientSecret,
                    username: username,
                    password: password
                }
            })
        };
        this.postRefreshToken = function () {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/oauth/v2/token",
                data: {
                    grant_type: "refresh_token",
                    client_id: "1_web",
                    client_secret: "web",
                    refresh_token: this.AuthInfo().refresh_token
                }
            })
        };
        this.getFeatures = function () {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postFeature = function (title, description) {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'feature[title]': title,
                    'feature[imageUrl]': "http://lorempixel.com/100/100/",
                    'feature[description]': description
                }
            })
        };
        this.putFeature = function (feature, title, description) {
            return $.ajax({
                method: "PUT",
                url: baseUrl + "/features/" + feature,
                headers: this.getAuthorizationHeaders(),
                data: {
                    'feature[title]': title,
                    'feature[description]': description,
                    'feature[imageUrl]': "http://lorempixel.com/100/100/"
                }
            })
        };
        this.deleteFeature = function (feature) {
            return $.ajax({
                url: baseUrl + "/features/" + feature,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.getQuests = function (feature) {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features/" + feature + "/quests",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.putQuest = function (feature, quest, title, description, maxLevel) {
            return $.ajax({
                method: "PUT",
                url: baseUrl + "/features/" + feature + "/quests/" + quest,
                headers: this.getAuthorizationHeaders(),
                data: {
                    'quest[title]': title,
                    'quest[description]': description,
                    'quest[maxLevel]': maxLevel
                }
            })
        };
        this.deleteQuest = function (feature, quest) {
            return $.ajax({
                url: baseUrl + "/features/" + feature + "/quests/" + quest,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.getUser = function () {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/user",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postQuest = function (feature, title, description, maxLevel) {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features/" + feature + "/quests",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'quest[title]': title,
                    'quest[description]': description,
                    'quest[maxLevel]': maxLevel
                }
            })
        };
        this.isAuthorized = function () {
            if (this.AuthInfo() !== undefined) {
                return true;
            }
            this.setAuthInfo(JSON.parse(localStorage.getItem('AuthInfo')));
            return this.AuthInfo() !== null;
        };
    }

    //апи клиента
    var apiClient = new ApiClient();

    //запрашивает и выводит данные, которые видны на главной странице изначально (+- я ещё не придумал чёткий коммент)
    var updateFeatures = function () {
        apiClient.getFeatures().success(function (FeatureInfo) {
            $("#headerText3").text(JSON.stringify(FeatureInfo));
            requestUserInfo();
            templateList.empty();
            templateColumn.empty().hide();
            $(".ui.list.quests").empty();

            for (var i = 1; i <= FeatureInfo.features.length; i++) {
                templateList.append(template(FeatureInfo.features[i - 1]));
                templateColumn.append(template2(FeatureInfo.features[i - 1]));
               // if (!templateListQuests.html().length) {
                    //updateQuests(FeatureInfo.features[i - 1]);
               // }
            }

            $('.item.feature').click(function () {
                //$('#templateListQuests'+this.dataset.id).empty();
                if ($('#templateListQuests'+this.dataset.id).html().length == 0) {
                    updateQuests(this.dataset.id);
                }
                //делает видимым только указанный контейнер
               $(".containerFeature").hide().parent().hide();
               $("#containerFeature"+this.dataset.id).show().parent().show();
            });
        }).fail(function (xhr) {
            console.log(xhr);
            if (xhr.status == 401) {
                apiClient.postRefreshToken()
                        .success(function (a) {
                                    apiClient.setAuthInfo(a);
                                    localStorage.setItem('AuthInfo', JSON.stringify(apiClient.AuthInfo()));
                                    $(".button.signIn").hide();
                                    $(".button.signOut").show();
                                    updateFeatures();
                                }
                        );
            }
        });
    };






    //срабатывает при обновлении страницы
    if (apiClient.isAuthorized()) {
        $(".button.signOut").show();
        $(".button.signIn").hide();
        updateFeatures();
    }
    else {
        $(".button.signIn").show();
        $(".button.signOut").hide();
    }


</script>
<script src="js/deleteFeature.js"></script>
<script src="js/createFeature.js"></script>
<script src="js/updateFeature.js"></script>
<script src="js/signIn.js"></script>
<script src="js/questFunctions.js"></script>
<script src="js/userDataFunctions.js"></script>

</body>
</html>