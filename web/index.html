<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="css/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #ffffff;
            background-size: cover;
        }
        .layer {
            overflow-x: auto; /* Добавляем полосу прокрутки */
            width: auto; /* Ширина блока */
            height: auto; /* Высота блока */
            padding: 5px; /* Поля вокруг текста */
            border: solid 1px white; /* Параметры рамки */
            white-space: nowrap; /* Запрещаем перенос строк */
        }

    </style>
</head>
<body>
<h1></h1>
<div class="ui container">
    <div class="ui five column grid">
        <div class="row">
            <div class="left floated three wide column">
                <div class="ui red huge left label">
                    Мой уровень
                </div>
            </div>
            <div class="left floated three wide column">
                <button id="buttonCreateFeature" class="ui button" type="submit">Create new feature</button>
            </div>

            <div class="left floated two wide column">
                <button id="buttonCreateRandomFeature" class="ui button" type="submit">Create new random feature</button>
            </div>

            <div class="right floated two wide column">
                <button id="buttonDeleteFeature" class="ui button" type="submit">Delete feature</button>
            </div>
            <div class="right floated two wide column">
                <button id="buttonSignIn" class="ui button" type="submit" style="display: none">Sign In</button>
            </div>
        </div>
    </div>


    <div id="modalLogin" class="ui small modal">
        <div class="content">
            <form id="loginForm" class="ui form">
                <div id="loginField" class="required field">
                    <label>Login</label>
                    <input id= "loginInput" type="text" name="first-name" placeholder="test" maxlength="50">
                </div>
                <div id="passwordField" class="required field">
                    <label>Password</label>
                    <input id="passwordInput" type="text" name="last-name" placeholder="test" maxlength="50">
                    </div>
            </form>
        </div>
        <div class="actions">
            <div id="buttonLogin" class="ui bottom attached positive button">
                Login
            </div>
        </div>
    </div>

    <div id="modalDeleteFeature" class="ui small modal">
        <div class="header">
            Choose a feature to delete
        </div>
        <div class="content">
            <div id ="deleteDropdown" class="ui selection dropdown">
                <input name="gender" type="hidden">
                <i class="dropdown icon"></i>
                <div class="default text"></div>
                <div id="templateMenuDeleteFeature" class="menu">
                </div>
            </div>
        </div>
        <div class="actions">
            <div id="buttonDelete" class="ui positive button">
                Delete
            </div>
            <div class="ui black deny button">
                Cancel
            </div>
        </div>
    </div>

    <div id="modalCreateFeature" class="ui small modal">
        <div class="header">
            Create feature
        </div>
        <div class="content">
            <form id="createFeatureForm" class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInput" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInput" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Image</label>
                    <input type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Create
            </div>
            <div class="ui black deny button">
                Cancel
            </div>
        </div>
    </div>



    <div class="layer">
        <div id="templateList" class="ui massive horizontal list"></div>
    </div>



    <h4 id="headerText" class="ui header"></h4>
    <h4 id="headerText2" class="ui header"></h4>
    <h4 id="headerText3" class="ui header"></h4>
</div>

<script id="templateFeature" type="text/x-handlebars-template">
    <div id="itemFeature{{id}}" class="item">
        <img class="ui avatar image" src={{image_url}}>
        <div class="content">
            <div class="header">{{title}}</div>
            уровень {{level}}
        </div>
    </div>
</script>

<script id="templateDeleteFeature" type="text/x-handlebars-template">
    <div class="item" data-value="0">{{title}}</div>
</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="js/semantic.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>


<script>

var username1, password1;
var AuthInfo, FeatureInfo;
var title1, description1;
//var featureid;


    $( "#loginInput" )
            .keyup(function(){
                username1 = $( this ).val();
            }).keyup();

    $( "#passwordInput" )
            .keyup(function(){
                password1 = $( this ).val();
            }).keyup();

$( "#titleInput" )
        .keyup(function(){
            title1 = $( this ).val();
        }).keyup();
$( "#descriptionInput" )
        .keyup(function(){
            description1 = $( this ).val();
        }).keyup();

$( "#buttonSignIn" ).click(function(){
    $("#modalLogin")
            .modal({
                autofocus : true,
                transition : 'fade down',
                onApprove : function(){
                    if(username1=="" || password1 ==""){
                        return false;
                    }
                    else{
                        firstAuthorization();
                    }
                }
            })
            .modal('show')
    ;
});

$("#buttonCreateFeature").click(function(){
$("#modalCreateFeature")
        .modal({
            autofocus: true,
            transition: 'fade down',
            onDeny: function(){
                $( "#titleInput").val("");
                $( "#descriptionInput").val("");

            },
            onApprove: function(){
                if($( "#titleInput").val()=="" || $( "#descriptionInput").val()==""){
                    alert("минимум одно из полей пустое");
                    return false;
                }
                else{
                    requestCreateFeature();
                    return false;
                }
            }
        })
        .modal('show')
});

$( "#buttonDeleteFeature").click(function(){
   $("#modalDeleteFeature")
           .modal({
               autofocus: true,
               transition: 'fade down',
               onShow: function () {
                     updateFeatures();
                     deleteDropdownRefill();
               },
               onDeny: function(){

                   $('#deleteDropdown').dropdown('restore defaults');
               },
               onApprove: function () {
                   if ($('#deleteDropdown').dropdown('get text') == "") {
                       return false;
                   }
                   else {
                       for (var i = 0; i < FeatureInfo.features.length; i++) {
                            if (FeatureInfo.features[i].title == $('#deleteDropdown').dropdown('get text')) {
                                requestDeleteFeature(FeatureInfo.features[i].id);
                                //alert("Для удаления выбран элемент с id " + FeatureInfo.features[i].id + " и названием " + FeatureInfo.features[i].title);
                            }
                       }

                       return false;
                   }
               }

           })
           .modal('show')
});
//$("#buttonCreateRandomFeature").click(function(){
//    $.ajax({
//        method: "POST",
//        url: "/app_dev.php/api/features",
//        headers: {Authorization: 'Bearer ' + AuthInfo.access_token}
//    }).success(function(){
//            updateFeatures();
//            alert("успех?");
//                    })}
//);

$('#deleteDropdown')
       .dropdown({
       })
        .dropdown()
;

    var isAuthorized = function() {
        if(AuthInfo !== undefined) {
            return AuthInfo;
        }

        AuthInfo = JSON.parse(localStorage.getItem('AuthInfo'));
        if(AuthInfo !== null) {
            return AuthInfo;
        }

        $( "#buttonSignIn" ).fadeIn();
        return false;
    };

    var updateFeatures = function() {
        $.ajax({
            method: "GET",
            url: "/app_dev.php/api/features",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token}
        }).success(function (z) {
            FeatureInfo = z;
            $("#headerText3").text(JSON.stringify(FeatureInfo));

            $( "#templateList" ).empty();

            var template = Handlebars.compile( $('#templateFeature').html() );
            for (var i = 1; i <= FeatureInfo.features.length; i++) {

                $('#templateList').append( template(FeatureInfo.features[i-1]) );
                $("#itemFeature" + i).attr({
                    "data-title": FeatureInfo.features[i-1].title,
                    "data-content": FeatureInfo.features[i-1].description
                });
                $("#itemFeature" + i)
                        .popup({
                            on: 'click'
                        })
                ;
            }

        }).fail(function(xhr) {
            console.log(xhr);
            if(xhr.status == 401) {
                $.post("/app_dev.php/api/oauth/v2/token", {
                    grant_type: "refresh_token",
                    client_id: "1_web",
                    client_secret: "web",
                    refresh_token: AuthInfo.refresh_token
                }).success(function(a){
                    AuthInfo=a;
                    localStorage.setItem('AuthInfo',JSON.stringify(AuthInfo));
                    $( "#buttonSignIn" ).fadeOut();
                    updateFeatures();
                });
            }
        });
    };

    var firstAuthorization = function(){
        $.post("/app_dev.php/api/oauth/v2/token", {
            grant_type: "password",
            client_id: "1_web",
            client_secret: "web",
            username: username1,
            password: password1
        }).success(function(a){
            AuthInfo=a;
            localStorage.setItem('AuthInfo',JSON.stringify(AuthInfo));
            $("#headerText").text(JSON.stringify(AuthInfo));
            //$("#headerText2").text(username1 + " " + password1);
            $( "#buttonSignIn" ).fadeOut();
            updateFeatures();
        });
    };


    var deleteDropdownRefill = function(){
        $("#templateMenuDeleteFeature").empty();
        var template = Handlebars.compile($('#templateDeleteFeature').html());
        for (var i = 0; i < FeatureInfo.features.length; i++) {

            $('#templateMenuDeleteFeature').append(template(FeatureInfo.features[i]));
        }
    };

    var requestDeleteFeature = function(featureId){
        $.ajax({
            url: "/app_dev.php/api/features/" + featureId,
            type: 'DELETE',
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token},
            success: function() {
                updateFeatures();
                deleteDropdownRefill();
                $('#deleteDropdown').dropdown('restore defaults');
                alert("Feature " + featureId + " was successfully deleted");
            }
        });
    };

    var requestCreateFeature = function(){
        $.ajax({
            method: "POST",
            url: "/app_dev.php/api/features",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token},
            data: {'feature[title]' : title1, 'feature[imageUrl]' : "http://lorempixel.com/100/100/", 'feature[description]' : description1},
            success: function(){

                $( "#titleInput").val("");
                $( "#descriptionInput").val("");
                updateFeatures();
                alert("новая фича создана?");
            }
        })
    };




    if (isAuthorized()) {
        updateFeatures();
    }







/*function Ucfirst(str){
    if (!str) return str;
    return str[0].toUpperCase() + str.substring(1);
}*/


</script>


</body>
</html>