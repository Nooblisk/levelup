<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="vendor/semantic/css/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #ffffff;
            background-size: cover;
        }
    </style>
</head>
<body>


<!--Контейнер содержащий список фич и их отображение + квесты-->
<div id="templateList" class="ui sidebar inverted vertical menu left"
     style="width:200px !important;white-space:nowrap;padding:5px;border:solid 1px;"></div>

<div class="pusher">
    <h1></h1>
    <h1></h1>

    <div class="ui container">

        <div class="ui fixed inverted top menu">
            <a id="buttonLeftMenu" class="item">Features</a>
            <div id="buttonUserInfo" class="ui dropdown item" style="display: none">
                UserInfo
                <i class="dropdown icon"></i>
                <div class="menu">
                    <a id="userUsername" class="item"></a>
                    <a id="userLevel" class="item"></a>
                    <a id="userEmail" class="item"></a>
                    <a id="buttonLogOut" class="item">Log out</a>
                </div>
            </div>
            <a id="buttonSignIn" class="item" style="display: none">Login</a>
            <!--<a id="buttonRegister" class="item" style="display: none">Register</a>-->
            <a id="buttonRefresh" class="item">
                <i class="refresh icon"></i>
            </a>
            <a id="statusBar" class="item" style="display: none">Идёт запрос к серверу</a>
        </div>


       <div id="templateColumn" class="ui raised very padded container"></div>

            <h4 id="headerText" class="ui header"></h4>
            <h4 id="headerText2" class="ui header"></h4>
            <h4 id="headerText3" class="ui header"></h4>
            <h4 id="headerText4" class="ui header"></h4>

        <!--Окно ввода логина и пароля-->
        <div id="modalAuthorization" class="ui small modal">
            <div class="content">
                <form class="ui form authorization">
                    <div class="field">
                        <label>Login</label>
                        <input name="login" title="login" type="text" value="test">
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input name="password" title="password" type="password" value="test">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div id="buttonLogin" class="ui bottom attached positive button">
                    Login
                </div>
            </div>
        </div>

        <!--Окно регистрации-->
        <div id="modalRegistration" class="ui small modal">
            <div class="content">
                <form class="ui form registration">
                    <div class="field">
                        <label>E-mail</label>
                        <input name="emailRegister" title="E-mail" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Username</label>
                        <input name="usernameRegister" title="Username" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input name="passwordRegister" title="password" type="password" value="">
                    </div>
                    <div class="field">
                        <label>Repeat password</label>
                        <input name="passwordRepeatRegister" title="password" type="password" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui bottom attached positive button">
                    Register
                </div>
            </div>
        </div>


        <!--Окно создания новой фичи-->
        <div id="modalCreateFeature" class="ui small modal">
            <div class="header">
                Create feature
            </div>
            <div class="content">
                <form class="ui form create feature">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleCreateFeature" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionCreateFeature" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Image</label>
                        <input name="imageUrlCreateFeature" title="imageUrl" type="text"
                               value="http://lorempixel.com/100/100/">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Create
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

        <!--Окно добавления нового квеста-->
        <div id="modalCreateQuest" class="ui small modal">
            <div class="header">
                Create quest
            </div>
            <div class="content">
                <form class="ui form create quest">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleCreateQuest" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionCreateQuest" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Number of steps</label>
                        <input name="maxLevelCreateQuest" title="maxLevel" type="text" value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>featureId</label>
                        <input name="featureIdCreateQuest" title="featureId" type="text" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Create
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

        <!--Окно обновления фичи-->
        <div id="modalUpdateFeature" class="ui small modal">
            <div class="header">
                Update feature
            </div>
            <div class="content">
                <form class="ui form update feature">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleUpdateFeature" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionUpdateFeature" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Image</label>
                        <input name="imageUrlUpdateFeature" title="imageUrl" type="text"
                               value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>featureId</label>
                        <input name="featureIdUpdateFeature" title="featureId" type="text" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Update
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

        <!--Окно обновления фичи-->
        <div id="modalUpdateQuest" class="ui small modal">
            <div class="header">
                Update quest
            </div>
            <div class="content">
                <form class="ui form update quest">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleUpdateQuest" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionUpdateQuest" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>maxLevel</label>
                        <input name="maxLevelUpdateQuest" title="maxLevel" type="text" value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>featureId</label>
                        <input name="featureIdUpdateQuest" title="featureIdUpdateQuest" type="text" value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>questId</label>
                        <input name="questIdUpdateQuest" title="questIdUpdateQuest" type="text" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Update
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

    </div>
</div>



<script id="templateFeature" type="text/x-handlebars-template">
    <a id= "itemFeature{{id}}" class="item feature" data-tab="{{id}}" data-id="{{id}}">
        <img id="imageItemFeature{{id}}" class="ui avatar image" src={{image_url}}>
        <div id="levelItemFeature{{id}}" class="ui teal label">{{level}}</div>
        <div id="titleItemFeature{{id}}" class="ui container">{{title}}</div>
    </a>
</script>


<!--Шаблон контейнера с информацией о фиче и кнопками-->
    <script id="templateContainerUpSegment" type="text/x-handlebars-template">
        <div id="containerFeature{{id}}" class="ui bottom attached tab container" data-tab="{{id}}" data-id="{{id}}">
            <div class="ui container">
                <div class="ui items">
                    <div class="item">
                        <div class="ui tiny image">
                            <img id="imageContainerFeature{{id}}" src={{image_url}}>
                        </div>
                        <div class="content">
                            <a id="titleContainerFeature{{id}}" class="header">{{title}}</a>

                            <div class="meta">
                                <span id="levelContainerFeature{{id}}">уровень {{level}}</span>
                            </div>
                            <div class="description">
                                <p id="descriptionContainerFeature{{id}}">{{description}}</p>
                            </div>
                            <div class="extra">
                                <button class="ui quest post compact green icon button" title="add quest" data-id="{{id}}">
                                    <i class="plus icon"></i>
                                </button>
                                <button class="ui feature update compact yellow icon button" title="update feature" data-id="{{id}}">
                                    <i class="write icon"></i>
                                </button>
                                <button class="ui feature delete compact red icon button" title="delete feature" data-id="{{id}}">
                                    <i class="remove circle outline icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="templateListQuests{{id}}" class="ui list quests" data-id="{{id}}"
                     style="white-space:nowrap;padding:5px;border:solid 1px white;"></div>
            </div>
        </div>
    </script>

<!--Шаблон списка квестов по данной фиче-->
<script id="templateContainerDownSegment" type="text/x-handlebars-template">
    <div id="itemQuest{{id}}" class="item quest" data-id="{{id}}">
        <div class="content">
            <div id="titleQuest{{id}}" class="header">{{title}}</div>
            <div class="description">
                <p id="descriptionQuest{{id}}">{{description}}</p>
                <div id="steps{{id}}" class="ui small teal progress" data-value="{{level}}" data-total="{{max_level}}" style="width:300px">
                    <div class="bar"></div>
                    <div class="label">шагов {{level}} из {{max_level}} выполнено</div>
                </div>
            </div>
            <div class="extra">
                <div class="ui left floated quest update icon button" title="update quest" data-id="{{id}}">
                    <i class="write icon" data-id="{{id}}"></i>
                </div>
                <div class="ui left floated quest delete icon button" title="delete quest" data-id="{{id}}">
                    <i class="trash icon" data-id="{{id}}"></i>
                </div>
                <div class="ui left floated step down icon button" title="step down" data-id="{{id}}">
                    <i class="minus circle icon" data-id="{{id}}"></i>
                </div>
                <div class="ui left floated step up icon button" title="step up" data-id="{{id}}">
                     <i class="add circle icon" data-id="{{id}}"></i>
                </div>
            </div>

        </div>
    </div>
</script>


<script src="vendor/jquery/jquery-2.2.1.min.js"></script>
<script src="vendor/semantic/js/semantic.min.js"></script>
<script src="vendor/handlebars/handlebars-v4.0.5.js"></script>

<script src="js/reactiveTest.js"></script>
<script src="js/requestAndFillFeatures.js"></script>
<script src="js/requestAndFillQuests.js"></script>
<script src="js/userDataFunctions.js"></script>

<script>


    var templateList = $("#templateList");
    var templateColumn = $("#templateColumn");

    var formAuthorization = $('.form.authorization');
    var formRegistration = $('.form.registration');
    var formCreateFeature = $('.form.create.feature');
    var formUpdateFeature = $('.form.update.feature');
    var formCreateQuest = $('.form.create.quest');
    var formUpdateQuest = $('.form.update.quest');
    var buttonRefresh = $("#buttonRefresh");
    var buttonLeftMenu = $("#buttonLeftMenu");

    buttonLeftMenu.click(function () {
        $('.ui.sidebar').sidebar({
                    dimPage: false,
                    closable: false
                })
                .sidebar('toggle')
        ;
    });

    $('.dropdown.item')
            .dropdown({
                transition: 'scale'
            })
    ;


    var template = Handlebars.compile($('#templateFeature').html());
    var template2 = Handlebars.compile($('#templateContainerUpSegment').html());
    var template3 = Handlebars.compile($('#templateContainerDownSegment').html());


    function Spiner() {
        var count;
        this.up = function () {
            count++;
        };
        this.down = function () {
            count--;
        };
        this.count = function () {
            return count;
        };
        this.drop = function () {
            count = 0;
        };
    }
    var spiner = new Spiner();


    var statusBar = function () {
        if (spiner.count() > 0) {
            $("#statusBar").show();
        }
        else {
            $("#statusBar").hide();
        }
    };

    //конструктор апи клиента, содержит все необходимые методы для работы с апи сервера(ещё не все)
    function ApiClient() {
        var baseUrl = "/app_dev.php/api";
        var clientId = "1_web";
        var clientSecret = "web";
        var AuthInfo;
        var FeatureInfo;
        var UserInfo;
        var QuestInfo = {};
        this.setQuestInfo = function (feature, QuestInfoObject) {
            QuestInfo["feature" + feature] = QuestInfoObject;
        };
        this.QuestInfo = function (feature) {
            return QuestInfo["feature" + feature];
        };
        this.QuestInfoAll = function () {
            return QuestInfo;
        };
        this.setAuthInfo = function (AuthInfoObject) {
            AuthInfo = AuthInfoObject;
        };
        this.AuthInfo = function () {
            return AuthInfo;
        };
        this.setUserInfo = function (UserInfoObject) {
            UserInfo = UserInfoObject;
        };
        this.UserInfo = function () {
            return UserInfo;
        };
        this.setFeatureInfo = function (FeatureInfoObject) {
            FeatureInfo = FeatureInfoObject;
        };
        this.FeatureInfo = function () {
            return FeatureInfo;
        };
        this.featureOrder = function (feature) {
            for (var i = 0; i < apiClient.FeatureInfo().features.length; i++) {
                if (apiClient.FeatureInfo().features[i].id == feature) {
                    return i;
                }
            }
            return -1;
        };
        this.questOrder = function (feature, quest) {
            for (var i = 0; i < apiClient.QuestInfo(feature).quests.length; i++) {
                if (apiClient.QuestInfo(feature).quests[i].id == quest) {
                    return i;
                }
            }
            return -1;
        };
        this.postAuthorization = function (username, password) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "POST",
                url: baseUrl + "/oauth/v2/token",
                data: {
                    grant_type: "password",
                    client_id: clientId,
                    client_secret: clientSecret,
                    username: username,
                    password: password
                }
            })
        };
        this.postRefreshToken = function () {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "POST",
                url: baseUrl + "/oauth/v2/token",
                data: {
                    grant_type: "refresh_token",
                    client_id: "1_web",
                    client_secret: "web",
                    refresh_token: this.AuthInfo().refresh_token
                }
            })
        };
        this.isAuthorized = function () {
            if ((this.AuthInfo() !== undefined) && (this.AuthInfo() !== null)) {
                return true;
            }
            this.setAuthInfo(JSON.parse(localStorage.getItem('AuthInfo')));
            return ((this.AuthInfo() !== undefined) && (this.AuthInfo() !== null));
        };
        this.getAuthorizationHeaders = function () {
            return {Authorization: 'Bearer ' + this.AuthInfo().access_token};
        };
        this.getFeatures = function () {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features",
                headers: this.getAuthorizationHeaders()
            })

        };
        this.postFeature = function (title, description, imageUrl) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'feature[title]': title,
                    'feature[imageUrl]': imageUrl,
                    'feature[description]': description
                }
            })
        };
        this.putFeature = function (feature, title, description, imageUrl) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "PUT",
                url: baseUrl + "/features/" + feature,
                headers: this.getAuthorizationHeaders(),
                data: {
                    'feature[title]': title,
                    'feature[description]': description,
                    'feature[imageUrl]': imageUrl
                }
            })
        };
        this.deleteFeature = function (feature) {
            spiner.up();
            statusBar();
            return $.ajax({
                url: baseUrl + "/features/" + feature,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.getQuests = function (feature) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features/" + feature + "/quests",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.putQuest = function (feature, quest, title, description, maxLevel) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "PUT",
                url: baseUrl + "/features/" + feature + "/quests/" + quest,
                headers: this.getAuthorizationHeaders(),
                data: {
                    'quest[title]': title,
                    'quest[description]': description,
                    'quest[maxLevel]': maxLevel
                }
            })
        };
        this.deleteQuest = function (feature, quest) {
            spiner.up();
            statusBar();
            return $.ajax({
                url: baseUrl + "/features/" + feature + "/quests/" + quest,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.getUser = function () {
            spiner.up();
            return $.ajax({
                method: "GET",
                url: baseUrl + "/user",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postQuest = function (feature, title, description, maxLevel) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features/" + feature + "/quests",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'quest[title]': title,
                    'quest[description]': description,
                    'quest[maxLevel]': maxLevel
                }
            })
        };
        this.getSteps = function (feature, quest) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features/" + feature + "/quests/" + quest + "/steps",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postStep = function (feature, quest, comment) {
            spiner.up();
            statusBar();
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features/" + feature + "/quests/" + quest + "/steps",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'comment': comment
                }
            })
        };
        this.deleteStep = function (feature, quest, step) {
            spiner.up();
            statusBar();
            return $.ajax({
                url: baseUrl + "/features/" + feature + "/quests/" + quest + "/steps/" + step,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.isFeaturized = function () {
            if (this.FeatureInfo() !== undefined) {
                return true;
            }
            this.setFeatureInfo(JSON.parse(localStorage.getItem('FeatureInfo')));
            return this.FeatureInfo() !== null;
        };
        this.isUserized = function () {
            if (this.UserInfo() !== undefined) {
                return true;
            }
            this.setUserInfo(JSON.parse(localStorage.getItem('UserInfo')));
            return this.UserInfo() !== null;
        };
        this.isQuesterized = function (feature) {
            if (this.QuestInfo(feature) !== undefined) {
                return true;
            }
            this.setQuestInfo(feature, JSON.parse(localStorage.getItem('QuestInfo' + feature)));
            return this.QuestInfo(feature) !== null;
        };
        this.authFail = function (xhr, func, arg1, arg2, arg3, arg4, arg5) {
            spiner.down();
            statusBar();
            console.log(xhr);
            if (xhr.status == 401) {
                apiClient.postRefreshToken()
                        .success(function (a) {
                                    apiClient.setAuthInfo(a);
                                    localStorage.setItem('AuthInfo', JSON.stringify(apiClient.AuthInfo()));
                                    spiner.down();
                                    statusBar();
                                    return func(arg1, arg2, arg3, arg4, arg5);
                                }
                        )
                        .fail(function () {
                            spiner.down();
                            statusBar();
                            localStorage.removeItem('AuthInfo');
                            location.reload();
                        })
                ;
            }
        };
    }

    //апи клиента
    var apiClient = new ApiClient();


    buttonRefresh.click(function () {
        var refresh = function () {
            apiClient.getUser().success(function (UserInfo) {
                spiner.down();
                statusBar();
                apiClient.setUserInfo(UserInfo);
                localStorage.setItem('UserInfo', JSON.stringify(apiClient.UserInfo()));
                synchronizeFeaturesAndFill();
                apiClient.FeatureInfo().features.forEach(function (item) {
                    synchronizeQuestsAndFill(item.id);
                });
                //$('.item.feature').first().click();
            }).fail(function (xhr) {
                apiClient.authFail(xhr, refresh);
            });
        };
        refresh();
    });


    //срабатывает при обновлении страницы
    if (apiClient.isAuthorized()) {
        spiner.drop();
        $("#buttonUserInfo").show();
        $('.ui.sidebar').sidebar({
            dimPage: false,
            closable: false
        }).sidebar('show');
        if (apiClient.isFeaturized()) {
            featuresRender();
            $(".item.feature").first().click();
        }
        else {
            synchronizeFeaturesAndFill();
            $(".item.feature").first().click();
        }
        if (apiClient.isUserized()) {
            userInfoFill(apiClient.UserInfo());
        }
        else {
            synchronizeUserInfoAndFill();
        }
    }
    else {
        $("#buttonSignIn").show();
        $("#buttonRegister").show();
        buttonLeftMenu.hide();
        buttonRefresh.hide();
    }

    //инициализируем реактивную переменную(данные фич)
    var reactiveFeatureInfo = new ReactiveVar(apiClient.FeatureInfo());

    Tracker(function () {
        var FeatureInfo = reactiveFeatureInfo.get(); // начинаем отслеживание изменений переменной
        featuresFill(FeatureInfo); //Заполняем поля данными в связи с изменением нашей переменной
    });

    //инициализируем реактивную переменную(данные пользователя)
    var reactiveUserInfo = new ReactiveVar(apiClient.UserInfo());

    Tracker(function () {
        var UserInfo = reactiveUserInfo.get(); // начинаем отслеживание изменений переменной
        userInfoFill(UserInfo); //Заполняем поля данными в связи с изменением нашей переменной
    });


    //инициализируем реактивную переменную(данные пользователя)
    var reactiveQuestInfo = new ReactiveVar(apiClient.QuestInfoAll());

    Tracker(function () {
        var QuestInfo = reactiveQuestInfo.get(); // начинаем отслеживание изменений переменной
        questsFill(QuestInfo); //Заполняем поля данными в связи с изменением нашей переменной
    });


</script>
<script src="js/deleteFeature.js"></script>
<script src="js/createFeature.js"></script>
<script src="js/updateFeature.js"></script>
<script src="js/createQuest.js"></script>
<script src="js/updateQuest.js"></script>
<script src="js/deleteQuest.js"></script>
<script src="js/signIn.js"></script>
<script src="js/registration.js"></script>
<script src="js/stepFunctions.js"></script>

</body>
</html>