<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="css/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #ffffff;
            background-size: cover;
        }
    </style>
</head>
<body>


<!--Контейнер содержащий список фич и их отображение + квесты-->
<div id="templateList" class="ui sidebar inverted vertical menu left"
     style="width:200px !important;white-space:nowrap;padding:5px;border:solid 1px;"></div>

<div class="pusher">
    <h1></h1>
    <h1></h1>

    <div class="ui container">

        <div class="ui fixed inverted top menu">
            <a id="buttonLeftMenu" class="item">Features</a>
            <a id="buttonUserInfo" class="item" style="display: none">UserInfo</a>
            <a id="buttonSignIn" class="item" style="display: none">Sign In</a>
            <a id="buttonRefresh" class="item">
                <i class="refresh icon"></i>
            </a>
            <a id="buttonCreateFeature" class="item">Create new feature</a>
        </div>


       <div id="templateColumn" class="ui raised very padded container"></div>

            <h4 id="headerText" class="ui header"></h4>
            <h4 id="headerText2" class="ui header"></h4>
            <h4 id="headerText3" class="ui header"></h4>
            <h4 id="headerText4" class="ui header"></h4>

        <!--Окно информации о пользователе-->
        <div id="modalUserInfo" class="ui small modal">
            <div class="content">
                <div id="" class="ui card">
                    <div class="content">
                        <div id="userUsername" class="header"></div>
                        <div id="userLevel" class="meta"></div>
                        <div id="userEmail" class="description">

                        </div>
                    </div>
                    <div class="actions">
                        <div id="buttonSignOut" class="ui left attached green positive button">
                            SignOut
                        </div>
                        <div class="ui black deny button">
                            Close Window
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Окно ввода логина и пароля-->
        <div id="modalAuthorization" class="ui small modal">
            <div class="content">
                <form class="ui form authorization">
                    <div class="field">
                        <label>Login</label>
                        <input name="login" title="login" type="text" value="test">
                    </div>
                    <div class="field">
                        <label>Password</label>
                        <input name="password" title="password" type="password" value="test">
                    </div>
                    <!--<div class="ui submit button">Submit</div>-->
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div id="buttonLogin" class="ui bottom attached positive button">
                    Login
                </div>
            </div>
        </div>

        <!--Окно создания новой фичи-->
        <div id="modalCreateFeature" class="ui small modal">
            <div class="header">
                Create feature
            </div>
            <div class="content">
                <form class="ui form create feature">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleCreateFeature" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionCreateFeature" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Image</label>
                        <input name="imageUrlCreateFeature" title="imageUrl" type="text"
                               value="http://lorempixel.com/100/100/">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Create
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

        <!--Окно добавления нового квеста-->
        <div id="modalCreateQuest" class="ui small modal">
            <div class="header">
                Create quest
            </div>
            <div class="content">
                <form class="ui form create quest">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleCreateQuest" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionCreateQuest" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>maxLevel</label>
                        <input name="maxLevelCreateQuest" title="maxLevel" type="text" value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>featureId</label>
                        <input id="featureIdCreateQuest" title="featureId" type="text" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Create
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

        <!--Окно обновления фичи-->
        <div id="modalUpdateFeature" class="ui small modal">
            <div class="header">
                Update feature
            </div>
            <div class="content">
                <form class="ui form update feature">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleUpdateFeature" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionUpdateFeature" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Image</label>
                        <input name="imageUrlUpdateFeature" title="imageUrl" type="text"
                               value="http://lorempixel.com/100/100/">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>featureId</label>
                        <input id="featureIdUpdateFeature" title="featureId" type="text" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Update
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

        <!--Окно обновления фичи-->
        <div id="modalUpdateQuest" class="ui small modal">
            <div class="header">
                Update quest
            </div>
            <div class="content">
                <form class="ui form update quest">
                    <div class="field">
                        <label>Title</label>
                        <input name="titleUpdateQuest" title="title" type="text" value="">
                    </div>
                    <div class="field">
                        <label>Description</label>
                        <input name="descriptionUpdateQuest" title="description" type="text" value="">
                    </div>
                    <div class="field">
                        <label>maxLevel</label>
                        <input name="maxLevelUpdateQuest" title="maxLevel" type="text" value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>featureId</label>
                        <input id="featureIdUpdateQuest" title="featureIdUpdateQuest" type="text" value="">
                    </div>
                    <div class="disabled field" style="display:none">
                        <label>questId</label>
                        <input id="questIdUpdateQuest" title="questIdUpdateQuest" type="text" value="">
                    </div>
                    <div class="ui error message"></div>
                </form>
            </div>
            <div class="actions">
                <div class="ui positive button">
                    Update
                </div>
                <div class="ui black deny button">
                    Exit
                </div>
            </div>
        </div>

    </div>
</div>


<!--Шаблон фичи в списке-->
<script id="templateFeature" type="text/x-handlebars-template">
    <a class="item feature" data-tab="{{id}}" data-id="{{id}}">
        <img class="ui avatar image" src={{image_url}}>

        <div class="content">
            <div class="header">{{title}}</div>
            уровень {{level}}
        </div>

    </a>
</script>

<!--Шаблон контейнера с информацией о фиче и кнопками-->
    <script id="templateContainerUpSegment" type="text/x-handlebars-template">
        <div id="containerFeature{{id}}" class="ui bottom attached tab container" data-tab="{{id}}" data-id="{{id}}">
            <div class="ui container">
                <div class="ui items">
                    <div class="item">
                        <div class="ui tiny image">
                            <img src={{image_url}}>
                        </div>
                        <div class="content">
                            <a class="header">{{title}}</a>

                            <div class="meta">
                                <span>уровень {{level}}</span>
                            </div>
                            <div class="description">
                                <p>{{description}}</p>
                            </div>
                            <div class="extra">
                                <button class="ui quest post compact green icon button" title="add quest" data-id="{{id}}">
                                    <i class="plus icon"></i>
                                </button>
                                <button class="ui feature update compact yellow icon button" title="update feature" data-id="{{id}}">
                                    <i class="write icon"></i>
                                </button>
                                <button class="ui feature delete compact red icon button" title="delete feature" data-id="{{id}}">
                                    <i class="remove circle outline icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="templateListQuests{{id}}" class="ui list quests" data-id="{{id}}"
                     style="white-space:nowrap;padding:5px;border:solid 1px white;"></div>
            </div>
        </div>
    </script>

<!--Шаблон списка квестов по данной фиче-->
<script id="templateContainerDownSegment" type="text/x-handlebars-template">
    <div class="item quest" data-id="{{id}}">
        <div class="content">
            <div class="header">{{title}}</div>
            <div class="meta">
                <span>шаг {{level}} из {{max_level}}</span>
            </div>
            <div class="description">
                <p>{{description}}</p>
                <div id="steps{{id}}" class="ui indicating small progress" data-value="{{level}}" data-total="{{max_level}}" style="width:300px">
                    <div class="bar"></div>
                    <div class="label">шагов {{level}} из {{max_level}}</div>
                </div>
            </div>
            <div class="extra">
                <div class="ui left floated quest update icon button" title="update quest" data-id="{{id}}">
                    <i class="write icon"></i>
                </div>
                <div class="ui left floated quest delete icon button" title="delete quest" data-id="{{id}}">
                    <i class="trash icon"></i>
                </div>
                <div class="ui left floated step down icon button" title="step down" data-id="{{id}}">
                    <i class="minus circle icon"></i>
                </div>
                <div class="ui left floated step up icon button" title="step up" data-id="{{id}}">
                     <i class="add circle icon"></i>
                </div>
            </div>

        </div>
    </div>
</script>


<script src="js/jquery-2.2.1.min.js"></script>
<script src="js/semantic.min.js"></script>
<script src="js/handlebars-v4.0.5.js"></script>


<script src="js/requestAndFillQuests.js"></script>
<script src="js/userDataFunctions.js"></script>

<script>


    $("#buttonLeftMenu").click(function(){
        $('.ui.sidebar')
                .sidebar('toggle')
        ;
    });

    var templateList = $("#templateList");
    var templateColumn = $("#templateColumn");

    var formAuthorization = $('.form.authorization');
    var formCreateFeature = $('.form.create.feature');
    var formUpdateFeature = $('.form.update.feature');
    var formCreateQuest = $('.form.create.quest');
    var formUpdateQuest = $('.form.update.quest');


    var template = Handlebars.compile($('#templateFeature').html());
    var template2 = Handlebars.compile($('#templateContainerUpSegment').html());
    var template3 = Handlebars.compile($('#templateContainerDownSegment').html());


    //конструктор апи клиента, содержит все необходимые методы для работы с апи сервера(ещё не все)
    function ApiClient() {
        var baseUrl = "/app_dev.php/api";
        var clientId = "1_web";
        var clientSecret = "web";
        var AuthInfo;
        var FeatureInfo;
        var UserInfo;
        var QuestInfo =[];
        this.setQuestInfo = function (feature, QuestInfoObject) {
            QuestInfo[feature-1] = QuestInfoObject;
        };
        this.QuestInfo = function (feature) {
            return QuestInfo[feature-1];
        };
        this.setAuthInfo = function (AuthInfoObject) {
            AuthInfo = AuthInfoObject;
        };
        this.AuthInfo = function () {
            return AuthInfo;
        };
        this.setUserInfo = function (UserInfoObject) {
            UserInfo = UserInfoObject;
        };
        this.UserInfo = function () {
            return UserInfo;
        };
        this.setFeatureInfo = function (FeatureInfoObject) {
            FeatureInfo = FeatureInfoObject;
        };
        this.FeatureInfo = function () {
            return FeatureInfo;
        };
        this.postAuthorization = function (username, password) {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/oauth/v2/token",
                data: {
                    grant_type: "password",
                    client_id: clientId,
                    client_secret: clientSecret,
                    username: username,
                    password: password
                }
            })
        };
        this.postRefreshToken = function () {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/oauth/v2/token",
                data: {
                    grant_type: "refresh_token",
                    client_id: "1_web",
                    client_secret: "web",
                    refresh_token: this.AuthInfo().refresh_token
                }
            })
        };
        this.isAuthorized = function () {
            if ((this.AuthInfo() !== undefined) && (this.AuthInfo() !== null)) {
                return true;
            }
            this.setAuthInfo(JSON.parse(localStorage.getItem('AuthInfo')));
            return ((this.AuthInfo() !== undefined) && (this.AuthInfo() !== null));
        };
        this.getAuthorizationHeaders = function () {
                return {Authorization: 'Bearer ' + this.AuthInfo().access_token};
        };
        this.getFeatures = function () {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postFeature = function (title, description, imageUrl) {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'feature[title]': title,
                    'feature[imageUrl]': imageUrl,
                    'feature[description]': description
                }
            })
        };
        this.putFeature = function (feature, title, description, imageUrl) {
            return $.ajax({
                method: "PUT",
                url: baseUrl + "/features/" + feature,
                headers: this.getAuthorizationHeaders(),
                data: {
                    'feature[title]': title,
                    'feature[description]': description,
                    'feature[imageUrl]': imageUrl
                }
            })
        };
        this.deleteFeature = function (feature) {
            return $.ajax({
                url: baseUrl + "/features/" + feature,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.getQuests = function (feature) {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features/" + feature + "/quests",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.putQuest = function (feature, quest, title, description, maxLevel) {
            return $.ajax({
                method: "PUT",
                url: baseUrl + "/features/" + feature + "/quests/" + quest,
                headers: this.getAuthorizationHeaders(),
                data: {
                    'quest[title]': title,
                    'quest[description]': description,
                    'quest[maxLevel]': maxLevel
                }
            })
        };
        this.deleteQuest = function (feature, quest) {
            return $.ajax({
                url: baseUrl + "/features/" + feature + "/quests/" + quest,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.getUser = function () {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/user",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postQuest = function (feature, title, description, maxLevel) {
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features/" + feature + "/quests",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'quest[title]': title,
                    'quest[description]': description,
                    'quest[maxLevel]': maxLevel
                }
            })
        };
        this.getSteps = function (feature, quest) {
            return $.ajax({
                method: "GET",
                url: baseUrl + "/features/" + feature + "/quests/" + quest + "/steps",
                headers: this.getAuthorizationHeaders()
            })
        };
        this.postStep = function(feature, quest, comment){
            return $.ajax({
                method: "POST",
                url: baseUrl + "/features/" + feature + "/quests/" + quest + "/steps",
                headers: this.getAuthorizationHeaders(),
                data: {
                    'comment': comment
                }
            })
        };
        this.deleteStep = function (feature, quest, step) {
            return $.ajax({
                url: baseUrl + "/features/" + feature + "/quests/" + quest + "/steps/" + step,
                type: 'DELETE',
                headers: this.getAuthorizationHeaders()
            })
        };
        this.isFeaturized = function () {
            if (this.FeatureInfo() !== undefined) {
                return true;
            }
            this.setFeatureInfo(JSON.parse(localStorage.getItem('FeatureInfo')));
            return this.FeatureInfo() !== null;
        };
        this.isUserized = function () {
            if (this.UserInfo() !== undefined) {
                return true;
            }
            this.setUserInfo(JSON.parse(localStorage.getItem('UserInfo')));
            return this.UserInfo() !== null;
        };
        this.isQuesterized = function (feature) {
            if (this.QuestInfo(feature) !== undefined) {
                return true;
            }
            this.setQuestInfo(feature, JSON.parse(localStorage.getItem('QuestInfo'+feature)));
            return this.QuestInfo(feature) !== null;
        };
        this.authFail = function (xhr, func, arg1, arg2, arg3, arg4, arg5) {
            console.log(xhr);
            if (xhr.status == 401) {
                apiClient.postRefreshToken()
                        .success(function (a) {
                                    apiClient.setAuthInfo(a);
                                    localStorage.setItem('AuthInfo', JSON.stringify(apiClient.AuthInfo()));
                                    $("#buttonSignIn").hide();
                                    $(".button.signOut").show();
                                    return func(arg1, arg2, arg3, arg4, arg5);
                                }
                        )
                        .fail(function () {
                            localStorage.removeItem('AuthInfo');
                            location.reload();
                        })
                ;
            }
        };
    }

    //апи клиента
    var apiClient = new ApiClient();


    //заполняет страничку данными FeatureInfo (фичи)
    var featuresFill = function(){
        var FeatureInfo = apiClient.FeatureInfo();
        $("#headerText3").text(JSON.stringify(FeatureInfo));
        templateList.empty();
        templateColumn.empty();
        $(".ui.list.quests").empty();

        for (var i = 1; i <= FeatureInfo.features.length; i++) {
            //отрисовываем список фич поштучно
            templateList.append(template(FeatureInfo.features[i - 1]));
            //создаём каждой фиче контейнер
            templateColumn.append(template2(FeatureInfo.features[i - 1]));
        }
        $('.vertical.menu .item.feature')
                .tab()
        ;
        //навешиваем событие на клик по фиче из списка слева
        $('.item.feature').click(function () {
            $.tab('change tab', this.dataset.id);
            if (apiClient.isQuesterized(this.dataset.id)) {
                questsFill(this.dataset.id);
            }
            else {
                synchronizeQuests(this.dataset.id);
            }

        });

    };



    var synchronizeFeatures = function () {
        apiClient.getFeatures().success(function (FeatureInfo) {
                    apiClient.setFeatureInfo(FeatureInfo);
                    localStorage.setItem('FeatureInfo', JSON.stringify(apiClient.FeatureInfo()));
            featuresFill();
                }).fail(function(xhr){
            apiClient.authFail(xhr, synchronizeFeatures);
        });
    };

    $("#buttonRefresh").click(function(){

        synchronizeFeatures();
        synchronizeUserInfo();
        for(var i=1; i<=apiClient.FeatureInfo().features.length; i++){
            synchronizeQuests(i);
        }
    });

    //срабатывает при обновлении страницы
    if (apiClient.isAuthorized()) {
        $("#buttonUserInfo").show();
        if(apiClient.isFeaturized()){
            featuresFill();
        }
        else{
            synchronizeFeatures();
        }

        if(apiClient.isUserized()){
            userInfoFill();
        }
        else{
            synchronizeUserInfo();
        }

    }
    else {
        $("#buttonSignIn").show();
    }




</script>
<script src="js/deleteFeature.js"></script>
<script src="js/createFeature.js"></script>
<script src="js/updateFeature.js"></script>
<script src="js/createQuest.js"></script>
<script src="js/updateQuest.js"></script>
<script src="js/deleteQuest.js"></script>
<script src="js/signIn.js"></script>
<script src="js/stepFunctions.js"></script>

</body>
</html>