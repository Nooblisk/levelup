<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="css/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #ffffff;
            background-size: cover;
        }


    </style>
</head>
<body>
<h1></h1>

<div class="ui container">
    <div class="ui four column grid">
        <div class="row">
            <div class="left floated three wide column">
                <div class="ui red huge left label">
                    Мой уровень
                </div>
            </div>
            <div class="left floated three wide column">
                <button id="buttonCreateFeature" class="ui button" type="submit">Create new feature</button>
            </div>

            <div class="right floated two wide column">
                <button id="buttonDeleteFeature" class="ui button" type="submit">Delete feature</button>
            </div>
            <div class="right floated two wide column">
                <button id="buttonSignIn" class="ui button" type="submit" style="display: none">Sign In</button>
            </div>
        </div>
    </div>


    <div id="modalLogin" class="ui small modal">
        <div class="content">
            <form id="loginForm" class="ui form">
                <div id="loginField" class="required field">
                    <label>Login</label>
                    <input id="loginInput" type="text" name="first-name" placeholder="test" maxlength="50">
                </div>
                <div id="passwordField" class="required field">
                    <label>Password</label>
                    <input id="passwordInput" type="text" name="last-name" placeholder="test" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div id="buttonLogin" class="ui bottom attached positive button">
                Login
            </div>
        </div>
    </div>

    <div id="modalDeleteFeature" class="ui small modal">
        <div class="header">
            Choose a feature to delete
        </div>
        <div class="content">
            <div id="deleteDropdown" class="ui selection dropdown">
                <input name="gender" type="hidden">
                <i class="dropdown icon"></i>

                <div class="default text"></div>
                <div id="templateMenuDeleteFeature" class="menu">
                </div>
            </div>
        </div>
        <div class="actions">
            <div id="buttonDelete" class="ui positive button">
                Delete
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <div id="modalCreateFeature" class="ui small modal">
        <div class="header">
            Create feature
        </div>
        <div class="content">
            <form id="createFeatureForm" class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInput" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInput" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Image</label>
                    <input type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Create
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>


    <div class="ui two column grid container">
        <div class="left floated four wide column">
            <div id="templateList" class="ui massive list"
                 style="overflow-y:auto;white-space:nowrap;width:auto;height:390px;padding:5px;border:solid 1px white;"></div>
        </div>
        <div class="right floated twelve wide column">
            <div id="templateColumn" class="ui raised very padded container segment" style="display: none">

            </div>

        </div>
    </div>

    <h4 id="headerText" class="ui header"></h4>
    <h4 id="headerText2" class="ui header"></h4>
    <h4 id="headerText3" class="ui header"></h4>
    <h4 id="headerText4" class="ui header"></h4>
</div>


<script id="templateContainerUpSegment" type="text/x-handlebars-template">
    <div id="containerFeature{{id}}" style="display:none">
        <div class="ui items">
            <div class="item">
                <div class="ui tiny image">
                    <img src={{image_url}}>
                </div>
                <div class="content">
                    <a class="header">{{title}}</a>

                    <div class="description">
                        <p>{{description}}</p>
                    </div>
                    <div class="extra">
                        уровень {{level}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script id="templateContainerDownSegment" type="text/x-handlebars-template">
    <div id="containerQuest{{id}}" style="display:none">
        <h2 class="ui header">название квеста {{title}}</h2>
        <p>описание {{description}}</p>
    </div>
</script>


<script id="templateFeature" type="text/x-handlebars-template">
    <div id="itemFeature{{id}}" class="item">
        <img class="ui avatar image" src={{image_url}}>

        <div class="content">
            <div class="header">{{title}}</div>
            уровень {{level}}
        </div>
    </div>
</script>

<script id="templateDeleteFeature" type="text/x-handlebars-template">
    <div class="item" data-value="0">{{title}}</div>
</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="js/semantic.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>


<script>

    var username1, password1;
    var AuthInfo, FeatureInfo, QuestInfo;
    var title1, description1;
    var title2, description2;
    var AllQuestInfo =[];
    //var featureid;


    $("#loginInput")
            .keyup(function () {
                username1 = $(this).val();
            }).keyup();

    $("#passwordInput")
            .keyup(function () {
                password1 = $(this).val();
            }).keyup();

    $("#titleInput")
            .keyup(function () {
                title1 = $(this).val();
            }).keyup();
    $("#descriptionInput")
            .keyup(function () {
                description1 = $(this).val();
            }).keyup();

    $("#buttonSignIn").click(function () {
        $("#modalLogin")
                .modal({
                    autofocus: true,
                    transition: 'fade down',
                    onApprove: function () {
                        if (username1 == "" || password1 == "") {
                            return false;
                        }
                        else {
                            firstAuthorization();
                        }
                    }
                })
                .modal('show')
        ;
    });

    $("#buttonCreateFeature").click(function () {
        $("#modalCreateFeature")
                .modal({
                    autofocus: true,
                    transition: 'fade down',
                    onDeny: function () {
                        $("#titleInput").val("");
                        $("#descriptionInput").val("");

                    },
                    onApprove: function () {
                        if ($("#titleInput").val() == "" || $("#descriptionInput").val() == "") {
                            alert("минимум одно из полей пустое");
                            return false;
                        }
                        else {
                            requestCreateFeature();
                            return false;
                        }
                    }
                })
                .modal('show')
    });

    $("#buttonDeleteFeature").click(function () {
        $("#modalDeleteFeature")
                .modal({
                    autofocus: true,
                    transition: 'fade down',
                    onShow: function () {
                        //updateFeatures();
                        deleteDropdownRefill();
                    },
                    onDeny: function () {

                        $('#deleteDropdown').dropdown('restore defaults');
                    },
                    onApprove: function () {
                        if ($('#deleteDropdown').dropdown('get text') == "") {
                            return false;
                        }
                        else {
                            for (var i = 0; i < FeatureInfo.features.length; i++) {
                                if (FeatureInfo.features[i].title == $('#deleteDropdown').dropdown('get text')) {
                                    requestDeleteFeature(FeatureInfo.features[i].id);
                                    //alert("Для удаления выбран элемент с id " + FeatureInfo.features[i].id + " и названием " + FeatureInfo.features[i].title);
                                }
                            }

                            return false;
                        }
                    }

                })
                .modal('show')
    });


    $('#deleteDropdown')
            .dropdown({})
            .dropdown()
    ;

    var isAuthorized = function () {
        if (AuthInfo !== undefined) {
            return AuthInfo;
        }

        AuthInfo = JSON.parse(localStorage.getItem('AuthInfo'));
        if (AuthInfo !== null) {
            return AuthInfo;
        }

        $("#buttonSignIn").fadeIn();
        return false;
    };

    var updateFeatures = function () {
        $.ajax({
            method: "GET",
            url: "/app_dev.php/api/features",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token}
        }).success(function (z) {
            FeatureInfo = z;
            //updateAllQuests;
            $("#headerText3").text(JSON.stringify(FeatureInfo));
            $("#templateList").empty();
            $("#templateColumn").empty().hide();

            var template = Handlebars.compile($('#templateFeature').html());
            var template2 = Handlebars.compile($('#templateContainerUpSegment').html());
            //var template3 = Handlebars.compile($('#templateContainerDownSegment').html());

            for (var i = 1; i <= FeatureInfo.features.length; i++) {
                //updateQuests(i);
                $('#templateList').append(template(FeatureInfo.features[i - 1]));
                $('#templateColumn').append(template2(FeatureInfo.features[i - 1]));
                //$('#templateColumn').append(template3(QuestInfo.quests[i - 1]));
            }
            for (var t = 1; t <= FeatureInfo.features.length; t++) {
                $('#itemFeature' + t).click((function (e) {
                    return function () {
                        onlyOneContainer(e);
                        updateQuests(e);
                    }
                })(t));
            }



        }).fail(function (xhr) {
            console.log(xhr);
            if (xhr.status == 401) {
                $.post("/app_dev.php/api/oauth/v2/token", {
                    grant_type: "refresh_token",
                    client_id: "1_web",
                    client_secret: "web",
                    refresh_token: AuthInfo.refresh_token
                }).success(function (a) {
                    AuthInfo = a;
                    localStorage.setItem('AuthInfo', JSON.stringify(AuthInfo));
                    $("#buttonSignIn").fadeOut();
                    updateFeatures();
                });
            }
        });
    };


    var updateAllQuests = function(){
        for (var i = 1; i <= FeatureInfo.features.length; i++){
           AllQuestInfo[i-1] = updateQuests(i);
            //console.log(AllQuestInfo);
        }
    };

    var updateQuests = function (featureId) {
        $.ajax({
            method: "GET",
            url: "/app_dev.php/api/features/" + featureId + "/quests",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token}
        }).success(function (x) {
            QuestInfo = x;
           $("#headerText4").text(JSON.stringify(QuestInfo));
            //console.log(QuestInfo);
            return QuestInfo;

        })
    };

    var firstAuthorization = function () {
        $.post("/app_dev.php/api/oauth/v2/token", {
            grant_type: "password",
            client_id: "1_web",
            client_secret: "web",
            username: username1,
            password: password1
        }).success(function (a) {
            AuthInfo = a;
            localStorage.setItem('AuthInfo', JSON.stringify(AuthInfo));
            $("#headerText").text(JSON.stringify(AuthInfo));
            //$("#headerText2").text(username1 + " " + password1);
            $("#buttonSignIn").fadeOut();
            updateFeatures();
        });
    };


    var deleteDropdownRefill = function () {
        $("#templateMenuDeleteFeature").empty();
        var template = Handlebars.compile($('#templateDeleteFeature').html());
        for (var i = 0; i < FeatureInfo.features.length; i++) {

            $('#templateMenuDeleteFeature').append(template(FeatureInfo.features[i]));
        }
    };

    var requestDeleteFeature = function (featureId) {
        $.ajax({
            url: "/app_dev.php/api/features/" + featureId,
            type: 'DELETE',
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token},
            success: function () {
                updateFeatures();
                deleteDropdownRefill();
                $('#deleteDropdown').dropdown('restore defaults');
                alert("Feature " + featureId + " was successfully deleted");
            }
        });
    };

    var requestCreateFeature = function () {
        $.ajax({
            method: "POST",
            url: "/app_dev.php/api/features",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token},
            data: {
                'feature[title]': title1,
                'feature[imageUrl]': "http://lorempixel.com/100/100/",
                'feature[description]': description1
            },
            success: function () {

                $("#titleInput").val("");
                $("#descriptionInput").val("");
                updateFeatures();
                alert("новая фича создана?");
            }
        })
    };

    var requestUpdateFeature = function (featureId) {
        $.ajax({
            method: "PUT",
            url: "/app_dev.php/api/features/" + featureId,
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token},
            data: {
                'feature[title]': title2,
                'feature[imageUrl]': "http://lorempixel.com/100/100/",
                'feature[description]': description2
            },
            success: function () {

                //$( "#titleInput").val("");
                //$( "#descriptionInput").val("");
                updateFeatures();
                alert("новая фича " + featureId + " изменена");
            }
        })
    };


    var onlyOneContainer = function(featureId) {
        for (var j = 1; j <= FeatureInfo.features.length; j++) {
            $('#containerFeature' + j).hide().parent().hide();
        }
        $('#containerFeature' + featureId).show().parent().show();
    };

    if (isAuthorized()) {
        updateFeatures();
    }
















    /*function Ucfirst(str){
     if (!str) return str;
     return str[0].toUpperCase() + str.substring(1);
     }*/

    //    function truncate(str, maxlength){
    //        if(str.length > maxlength){
    //           return str.substring(0,maxlength-3)+"...";
    //        }
    //        else
    //        return str;
    //    }
    //function isEmpty(obj){
    //    var counter = 0;
    //    for (var key in obj){
    //      counter++
    //    }
    //    if (counter){
    //        return false;
    //    }
    //    return true;
    //};
    //
    //function summa(obj){
    //    var sum =0;
    //    if (!isEmpty(obj)){
    //  for (var key in obj){
    //      sum+=obj[key];
    //  } return sum; }
    //    return 0;
    //
    //};

</script>


</body>
</html>