<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="css/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #ffffff;
            background-size: cover;
        }


    </style>
</head>
<body>
<h1></h1>

<div class="ui container">
    <div class="ui three column grid">
        <div class="row">
            <div class="left floated three wide column">
                <div class="ui red huge left label">
                    Мой уровень
                </div>
            </div>
            <div class="left floated three wide column">
                <button id="buttonCreateFeature" class="ui button" type="submit">Create new feature</button>
            </div>


            <div class="right floated two wide column">
                <button id="buttonSignIn" class="ui button" type="submit" style="display: none">Sign In</button>
            </div>
        </div>
    </div>


    <div id="modalLogin" class="ui small modal">
        <div class="content">
            <form id="loginForm" class="ui form">
                <div id="loginField" class="required field">
                    <label>Login</label>
                    <input id="loginInput" type="text" name="first-name" placeholder="test" maxlength="50">
                </div>
                <div id="passwordField" class="required field">
                    <label>Password</label>
                    <input id="passwordInput" type="text" name="last-name" placeholder="test" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div id="buttonLogin" class="ui bottom attached positive button">
                Login
            </div>
        </div>
    </div>

    <div id="modalDeleteFeature" class="ui small modal">
        <div class="header">
            Choose a feature to delete
        </div>
        <div class="content">
            <div id="deleteDropdown" class="ui selection dropdown">
                <input name="gender" type="hidden">
                <i class="dropdown icon"></i>

                <div class="default text"></div>
                <div id="templateMenuDeleteFeature" class="menu">
                </div>
            </div>
        </div>
        <div class="actions">
            <div id="buttonDelete" class="ui positive button">
                Delete
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <div id="modalCreateFeature" class="ui small modal">
        <div class="header">
            Create feature
        </div>
        <div class="content">
            <form id="createFeatureForm" class="ui form">
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInput" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInput" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Image</label>
                    <input type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Create
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>

    <div id="modalUpdateFeature" class="ui small modal">
        <div class="header">
            Update feature
        </div>
        <div class="content">
            <form id="updateFeatureForm" class="ui form">
                <div class="disabled field">
                    <label>Id</label>
                    <input id="idInputUpdate" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Title</label>
                    <input id="titleInputUpdate" type="text" name="last-name" placeholder="" maxlength="50">
                </div>
                <div class="required field">
                    <label>Description</label>
                    <input id="descriptionInputUpdate" type="text" name="first-name" placeholder="" maxlength="50">
                </div>
                <div class="disabled field">
                    <label>Image</label>
                    <input type="text" name="first-name" placeholder="" maxlength="50">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui positive button">
                Update
            </div>
            <div class="ui black deny button">
                Exit
            </div>
        </div>
    </div>





    <div class="ui two column grid container">
        <div class="left floated four wide column">
            <div id="templateList" class="ui massive list"
                 style="overflow-y:auto;white-space:nowrap;width:auto;height:390px;padding:5px;border:solid 1px white;"></div>
        </div>
        <div class="right floated twelve wide column">
            <div id="templateColumn" class="ui raised very padded container" style="display: none">

            </div>
            <div id="templateListQuests" class="ui list"
                 style="overflow-y:auto;white-space:nowrap;width:auto;height:250px;padding:5px;border:solid 1px white;">

            </div>

        </div>
    </div>

    <h4 id="headerText" class="ui header"></h4>
    <h4 id="headerText2" class="ui header"></h4>
    <h4 id="headerText3" class="ui header"></h4>
    <h4 id="headerText4" class="ui header"></h4>
</div>


<script id="templateContainerUpSegment" type="text/x-handlebars-template">
    <div id="containerFeature{{id}}" class="containerfeature" style="display:none" data-id="{{id}}">
        <div class="ui container">
            <div class="ui tiny image">
                <img src={{image_url}}>
            </div>
            <div class="content">
                <a class="header">{{title}}</a>

                <div class="description">
                    <p>{{description}}</p>
                </div>
                <div class="extra">
                    уровень {{level}}
                </div>
            </div>
            <button class="ui feature delete compact negative icon button" data-id="{{id}}">
                <i class="trash outline icon"></i>
            </button>
            <button class="ui feature update compact button" data-id="{{id}}">
                Изменить
            </button>
        </div>
        <div class="ui container" >
            <h3>тут будут квесты</h3>
        </div>
    </div>
</script>

<script id="templateContainerDownSegment" type="text/x-handlebars-template">
    <div class="item quest" data-id="{{id}}">
        <div class="content">
            <div class="header">{{title}}</div>
            <div class="meta">
                <span>уровень {{level}} из {{max_level}}</span>
            </div>
            <div class="description">
                <p>{{description}}</p>
            </div>

        </div>
    </div>
</script>

<script id="templateFeature" type="text/x-handlebars-template">
    <div class="item feature" data-id="{{id}}">
        <img class="ui avatar image" src={{image_url}}>

        <div class="content">
            <div class="header">{{title}}</div>
            уровень {{level}}
        </div>
    </div>
</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="js/semantic.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
<script src="js/deleteFeature.js"></script>
<script src="js/createFeature.js"></script>
<script src="js/signIn.js"></script>


<script>

    var username1, password1;
    var AuthInfo, FeatureInfo;
    var title1, description1;
    var title2, description2;
    var UserInfo;


    $("#titleInputUpdate")
            .keyup(function () {
                title2 = $(this).val();
            }).keyup();
    $("#descriptionInputUpdate")
            .keyup(function () {
                description2 = $(this).val();
            }).keyup();



    $('#templateColumn').on("click", ".ui.feature.update.button", function (e) {
        $("#modalUpdateFeature")
                .modal({
                    autofocus: true,
                    transition: 'fade down',
                    onShow: function () {
                        $("#idInputUpdate").val(e.target.dataset.id);
                        $("#titleInputUpdate").val("");
                        $("#descriptionInputUpdate").val("");
                    },
                    onDeny: function () {
                        $("#idInputUpdate").val(e.target.dataset.id);
                        $("#titleInputUpdate").val("");
                        $("#descriptionInputUpdate").val("");

                    },
                    onApprove: function () {
                        if ($("#titleInputUpdate").val() == "" || $("#descriptionInputUpdate").val() == "") {
                            alert("минимум одно из полей пустое");
                            return false;
                        }
                        else {
                            console.log(e.target.dataset.id);
                            requestUpdateFeature(e.target.dataset.id);
                        }
                    }
                })
                .modal('show')
    });


    var isAuthorized = function () {
        if (AuthInfo !== undefined) {
            return AuthInfo;
        }
        AuthInfo = JSON.parse(localStorage.getItem('AuthInfo'));
        if (AuthInfo !== null) {
            return AuthInfo;
        }
        $("#buttonSignIn").fadeIn();
        return false;
    };


    var updateFeatures = function () {
        $.ajax({
            method: "GET",
            url: "/app_dev.php/api/features",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token}
        }).success(function (z) {
            FeatureInfo = z;
            //updateAllQuests();
            $("#headerText3").text(JSON.stringify(FeatureInfo));
            $("#templateList").empty();
            $("#templateColumn").empty().hide();

            var template = Handlebars.compile($('#templateFeature').html());
            var template2 = Handlebars.compile($('#templateContainerUpSegment').html());


            for (var i = 1; i <= FeatureInfo.features.length; i++) {
                $('#templateList').append(template(FeatureInfo.features[i - 1]));
                $('#templateColumn').append(template2(FeatureInfo.features[i - 1]));
            }


            $('.item.feature').click(function (e) {
                $('#templateListQuests').empty();
                if (!$('#templateListQuests').html().length) {
                    updateQuests(this.dataset.id);
                }

                onlyOneContainer(this.dataset.id);
            });
        }).fail(function (xhr) {
            console.log(xhr);
            if (xhr.status == 401) {
//                $.ajax({
//                    method: "POST",
//                    url: "/app_dev.php/api/oauth/v2/token",
//                    data: {
//                        grant_type: "refresh_token",
//                        client_id: "1_web",
//                        client_secret: "web",
//                        refresh_token: AuthInfo.refresh_token
//                    }
//                }).success(function (a) {
//                    AuthInfo = a;
//                    localStorage.setItem('AuthInfo', JSON.stringify(AuthInfo));
//                    $("#buttonSignIn").fadeOut();
//                    updateFeatures();
//                });
                AuthInfo.requestRefresh = requestRefresh;
                AuthInfo.requestRefresh();
            }
        });
    };

    function requestRefresh() {
        $.ajax({
            method: "POST",
            url: "/app_dev.php/api/oauth/v2/token",
            data: {
                grant_type: "refresh_token",
                client_id: "1_web",
                client_secret: "web",
                refresh_token: this.refresh_token
            }
        }).success(function (a) {
            AuthInfo = a;
            localStorage.setItem('AuthInfo', JSON.stringify(AuthInfo));
            $("#buttonSignIn").fadeOut();
            updateFeatures();
        });
    }

//    function AuthInfoConstruct(access_token, expires_in, token_type, scope, refresh_token) {
//        this.access_token = access_token;
//        this.expires_in = expires_in;
//        this.token_type = token_type;
//        this.scope = scope;
//        this.refresh_token = refresh_token;
//        this.requestRefresh = requestRefresh;
//    }




    var updateQuests = function (featureId) {
        $.ajax({
            method: "GET",
            url: "/app_dev.php/api/features/" + featureId + "/quests",
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token}
        }).success(function (x) {
            QuestInfo=x;
            var template3 = Handlebars.compile($('#templateContainerDownSegment').html());
            for(var i=1; i<=QuestInfo.quests.length; i++) {
                $('#templateListQuests').append(template3(QuestInfo.quests[i-1]));
            }
            $("#headerText4").text(JSON.stringify(QuestInfo));


        })
    };








    var requestUpdateFeature = function (featureId) {
        $.ajax({
            method: "PUT",
            url: "/app_dev.php/api/features/" + featureId,
            headers: {Authorization: 'Bearer ' + AuthInfo.access_token},
            data: {
                'feature[title]': title2,
                'feature[description]': description2,
                'feature[imageUrl]': "http://lorempixel.com/100/100/"
            },
            success: function () {

                //$( "#titleInput").val("");
                //$( "#descriptionInput").val("");
                updateFeatures();
                alert("фича " + featureId + " изменена");
            }
        })
    };


    var onlyOneContainer = function (featureId) {
        for (var j = 1; j <= FeatureInfo.features.length; j++) {
            $('#containerFeature' + j).hide().parent().hide();
        }
        $('#containerFeature' + featureId).show().parent().show();
    };

    if (isAuthorized()) {
        updateFeatures();
    }


    /*function Ucfirst(str){
     if (!str) return str;
     return str[0].toUpperCase() + str.substring(1);
     }*/

    //    function truncate(str, maxlength){
    //        if(str.length > maxlength){
    //           return str.substring(0,maxlength-3)+"...";
    //        }
    //        else
    //        return str;
    //    }
    //function isEmpty(obj){
    //    var counter = 0;
    //    for (var key in obj){
    //      counter++
    //    }
    //    if (counter){
    //        return false;
    //    }
    //    return true;
    //};
    //
    //function summa(obj){
    //    var sum =0;
    //    if (!isEmpty(obj)){
    //  for (var key in obj){
    //      sum+=obj[key];
    //  } return sum; }
    //    return 0;
    //
    //};

</script>


</body>
</html>